{
  double relativeScale=getRelativeScale();
  int drawableWidth=mDetailLevelManager.getScaledWidth();
  int drawableHeight=mDetailLevelManager.getScaledHeight();
  double offsetWidth=mTileWidth * relativeScale;
  double offsetHeight=mTileHeight * relativeScale;
  mViewport.set(mDetailLevelManager.getComputedViewport());
  mViewport.top=Math.max(mViewport.top,0);
  mViewport.left=Math.max(mViewport.left,0);
  mViewport.right=Math.min(mViewport.right,drawableWidth);
  mViewport.bottom=Math.min(mViewport.bottom,drawableHeight);
  int startRow=(int)Math.floor(mViewport.top / offsetHeight);
  int endRow=(int)Math.ceil(mViewport.bottom / offsetHeight);
  int startColumn=(int)Math.floor(mViewport.left / offsetWidth);
  int endColumn=(int)Math.ceil(mViewport.right / offsetWidth);
  mLastStateSnapshot=new StateSnapshot(this,startRow,endRow,startColumn,endColumn);
  return mLastStateSnapshot;
}
